# 🎉 라즈베리파이 센서 시스템 - 리팩토링 완료!

## ✅ 완료된 작업

동료의 **정상 작동 코드**를 기준으로 전체 시스템을 깔끔하게 리팩토링했습니다!

---

## 📦 생성/수정된 파일

### 🍓 라즈베리파이 코드 (`raspberry_pi/`)

| 파일 | 역할 | 상태 |
|------|------|------|
| `config.py` | 설정 파일 (IP, 핀 번호) | ✅ 수정 |
| `sensor_manager.py` | 센서 통합 관리 클래스 | ✅ 리팩토링 |
| `sensor_test.py` | 로컬 센서 테스트 | ✅ 새로 작성 |
| `sensor_client.py` | 서버 전송 클라이언트 | ✅ 리팩토링 |
| `requirements.txt` | 필수 패키지 | ✅ 수정 |
| `README_REFACTORED.md` | 사용 가이드 | ✅ 새로 작성 |
| `HOTSPOT_GUIDE.md` | 핫스팟 연결 가이드 | ✅ 새로 작성 |

---

## 🎯 지금 바로 시작하기

### 1️⃣ 맥북 IP 주소 확인
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

출력 예시:
```
inet 192.168.2.1 netmask 0xffffff00 broadcast 192.168.2.255
```
→ **`192.168.2.1`**이 맥북 IP입니다!

---

### 2️⃣ 라즈베리파이 설정 수정

PyCharm의 **원격 개발** 기능으로 라즈베리파이 파일 수정:

**파일**: `raspberry_pi/config.py`  
**수정 내용**:
```python
SERVER_URL = "http://192.168.2.1:8000/sensor"  # 맥북 IP로 변경
```

---

### 3️⃣ 맥북에서 서버 실행

#### 터미널 열기 (⌘ + Space → "터미널")
```bash
cd ~/Sinker_IOT
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

**중요**: `--host 0.0.0.0` 옵션 필수!

성공 시:
```
INFO:     Uvicorn running on http://0.0.0.0:8000
✅ 데이터베이스 초기화 완료
```

---

### 4️⃣ 라즈베리파이에서 센서 테스트

#### SSH 접속 (PyCharm 또는 터미널)
```bash
ssh pi@<라즈베리파이_IP>
cd ~/Sinker_IOT/raspberry_pi
```

#### 로컬 센서 테스트 (서버 연결 없이)
```bash
python3 sensor_test.py
```

출력 예시:
```
>> 1. 진동 센서 설정 완료 (GPIO 17)
>> 2. 토양 수분 센서 설정 완료 (SPI Bus0, Device0)
>> 3. 기울기 센서 설정 완료 (I2C 0x68)
------------------------------------------------------------
💧 토양 수분   : 512
🤸 가속도(X,Y,Z): 0.12, -0.04, 9.81
🔄 자이로(X,Y,Z): 0.50, -0.30, 0.10
💥 진동 감지값  : 0
```

센서가 정상 작동하면 **Ctrl+C**로 종료하고 다음 단계로!

---

### 5️⃣ 서버로 데이터 전송 시작

```bash
python3 sensor_client.py
```

정상 작동 시:
```
🚀 센서 클라이언트 시작
>> 1. 진동 센서 설정 완료 (GPIO 17)
>> 2. 토양 수분 센서 설정 완료 (SPI Bus0, Device0)
>> 3. 기울기 센서 설정 완료 (I2C 0x68)
▶️ 데이터 수집 및 전송 시작

📡 수분: 512 | 진동: 0 | 가속도 Z: 9.81 ✅ [1] 전송 성공 - 위험도: 0
📡 수분: 515 | 진동: 0 | 가속도 Z: 9.82 ✅ [2] 전송 성공 - 위험도: 0
```

진동 감지 시:
```
🚨🚨 [즉시 경고] 진동이 감지되었습니다! 🚨🚨
```

---

### 6️⃣ 웹 대시보드 접속

#### 맥북에서
```
http://localhost:8000
```

#### 다른 기기에서 (같은 핫스팟)
```
http://192.168.2.1:8000
```

---

## 🔧 PyCharm 원격 개발 설정

### 1. SSH 연결 설정
1. **PyCharm** > **Preferences** > **Tools** > **SSH Configurations**
2. **+** 클릭
3. 정보 입력:
   - Host: 라즈베리파이 IP
   - Port: 22
   - User: pi
   - Password: (라즈베리파이 비밀번호)

### 2. 원격 인터프리터 설정
1. **PyCharm** > **Preferences** > **Python Interpreter**
2. 톱니바퀴 아이콘 > **Add**
3. **SSH Interpreter** 선택
4. 위에서 만든 SSH 설정 선택
5. Interpreter 경로: `/usr/bin/python3`

### 3. 파일 동기화 (선택사항)
1. **Tools** > **Deployment** > **Configuration**
2. **+** 클릭 > **SFTP** 선택
3. SSH 설정 연결
4. 자동 업로드 설정

---

## 📊 전체 시스템 흐름

```
┌─────────────────────────────────────────────────────────────┐
│                    라즈베리파이                              │
│                                                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  진동 센서    │  │ 토양수분센서  │  │ 가속도센서    │      │
│  │  (GPIO17)    │  │  (MCP3008)   │  │  (MPU6050)   │      │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘      │
│         └─────────────────┴─────────────────┘               │
│                           │                                  │
│                ┌──────────▼──────────┐                       │
│                │  sensor_manager.py  │                       │
│                └──────────┬──────────┘                       │
│                           │                                  │
│                ┌──────────▼──────────┐                       │
│                │  sensor_client.py   │                       │
│                │  (1초마다 전송)      │                       │
│                └──────────┬──────────┘                       │
└───────────────────────────┼──────────────────────────────────┘
                            │ HTTP POST
                            │ (핫스팟)
                ┌───────────▼──────────┐
                │       맥북            │
                │                      │
                │  ┌────────────────┐  │
                │  │ FastAPI 서버   │  │
                │  │ (app/main.py)  │  │
                │  └────────┬───────┘  │
                │           │          │
                │  ┌────────▼───────┐  │
                │  │   데이터베이스  │  │
                │  └────────┬───────┘  │
                │           │          │
                │  ┌────────▼───────┐  │
                │  │  웹 대시보드    │  │
                │  │ :8000          │  │
                │  └────────────────┘  │
                └──────────────────────┘
```

---

## 🐛 문제 해결

### ❌ "연결 실패" 오류
```bash
# 1. 핑 테스트
ping 192.168.2.1

# 2. 서버 연결 테스트
curl http://192.168.2.1:8000/health

# 3. 서버 실행 확인 (맥북)
# 터미널에 "Uvicorn running on..." 메시지가 있어야 함
```

### ❌ 센서 읽기 오류
```bash
# GPIO/I2C/SPI 권한 확인
groups  # gpio, i2c, spi 그룹에 속해야 함

# 없으면 추가
sudo usermod -a -G gpio,i2c,spi $USER
sudo reboot
```

### ❌ 패키지 없음 오류
```bash
cd ~/Sinker_IOT/raspberry_pi
pip3 install -r requirements.txt
```

---

## 📚 주요 파일 설명

### 🔧 sensor_manager.py
모든 센서를 통합 관리하는 클래스
```python
manager = SensorManager()
data = manager.read_all()  # {"moisture": 512, "accel": {...}, ...}
manager.cleanup()
```

### 🧪 sensor_test.py
서버 없이 로컬에서만 센서 테스트
- 1초마다 센서 값 출력
- 진동 감지 시 이벤트 콜백

### 📡 sensor_client.py
서버로 데이터 전송
- 1초마다 자동 전송
- 재시도 로직 (최대 3회)
- 통계 출력

---

## ✨ 주요 개선사항

### ✅ 동료 코드 100% 반영
- GPIO17 진동 센서
- SPI MCP3008 토양 수분  
- I2C MPU6050 가속도/자이로
- 모든 핀 번호와 주소 일치

### ✅ 깔끔한 구조
- 모듈화된 설계
- 명확한 책임 분리
- 읽기 쉬운 코드

### ✅ 강력한 에러 처리
- 연결 실패 시 자동 재시도
- 타임아웃 처리
- 예외 안전성

### ✅ 상세한 로그
```
✅ [1] 전송 성공 - 위험도: 0
🚨 [즉시 경고] 진동이 감지되었습니다!
📊 성공률: 98.5%
```

---

## 🎓 다음 단계

1. **센서 캘리브레이션**: `calibrate_moisture.py` 실행
2. **자동 시작 설정**: systemd 서비스 등록
3. **로그 모니터링**: 로그 파일 확인 기능 추가
4. **알림 기능**: SMS, 이메일 알림 추가

---

## 📞 추가 문서

- **상세 가이드**: `README_REFACTORED.md`
- **핫스팟 연결**: `HOTSPOT_GUIDE.md`
- **배선 정보**: `WIRING.md` (기존)
- **빠른 시작**: `QUICKSTART.md` (기존)

---

## 🎯 요약

**이제 이 명령어만 실행하면 끝!**

```bash
# 맥북
cd ~/Sinker_IOT
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload

# 라즈베리파이
cd ~/Sinker_IOT/raspberry_pi
python3 sensor_client.py

# 브라우저
http://localhost:8000
```

**모든 코드는 동료의 정상 작동 코드를 기반으로 작성되었습니다!** 🎉

궁금한 점이 있으면 문서를 참고하거나 질문하세요! 😊
